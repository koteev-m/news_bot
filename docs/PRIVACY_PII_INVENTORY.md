# P36 — Data retention & privacy

## Scope / Определения
- **PII (персональные данные)** — любые данные, позволяющие идентифицировать физическое лицо (прямо или косвенно). В контексте бота это идентификаторы пользователей Telegram, их активности и связанные записи.
- **userId** — `users.user_id`, внутренний идентификатор пользователя. Связан с `tg_user_id` и используется во всех person-bound таблицах.
- **sessionId** — `events.session_id`, произвольный идентификатор сессии/корреляции от клиентов (mini-app, API).

## Инвентарь PII
| Таблица | Колонки PII | Назначение | Retention | Erasure |
| --- | --- | --- | --- | --- |
| `users` | `user_id`, `tg_user_id` | учетная запись пользователя | до явного удаления | удаление записи (финальный шаг) |
| `portfolios` | `user_id` | портфели пользователя | до erasure | удаление (каскад удаляет `trades`, `positions`, `valuations_daily`) |
| `trades` | через `portfolio_id` → `user_id` | история сделок | до erasure | удаляются каскадом |
| `positions` | через `portfolio_id` → `user_id` | текущее состояние портфеля | до erasure | удаляются каскадом |
| `valuations_daily` | через `portfolio_id` → `user_id` | дневные оценки стоимости | до erasure | удаляются каскадом |
| `alerts_rules` | `user_id` | правила уведомлений | до erasure | удаление |
| `alerts_events` | `user_id`, `ts` | журнал уведомлений | ≤30 дней | удаление |
| `user_alert_overrides` | `user_id` | индивидуальные настройки алертов | до erasure | удаление |
| `user_subscriptions` | `user_id` | биллинг-подписки | до erasure | удаление |
| `events` | `user_id`, `session_id`, `ts` | продуктовая аналитика | ≤90 дней | удаление по времени + erasure |
| `bot_starts` | `user_id`, `started_at` | события запуска бота | анонимизация user_id ≤30 дней | анонимизация `user_id` |
| `feature_overrides` | (нет PII) | глобальные флаги | постоянное хранение | n/a |
| `cta_clicks` | (нет PII: `user_agent` не является идентификатором) | статистика CTA | ≤90 дней | n/a |
| `post_stats` | (нет PII) | агрегаты по публикациям | постоянное хранение | n/a |

> Таблицы без PII включены для полноты инвентаря: контролируем, что политики retention/erasure к ним не применяются.

## Retention политика
- **Analytics events (`events`)** — хранятся не более 90 дней; очистка выполняется ежедневным планировщиком и может быть запущена администратором вручную.
- **Alerts events (`alerts_events`)** — удаляются по истечении 30 дней.
- **Bot starts (`bot_starts`)** — через 30 дней поле `user_id` устанавливается в `NULL`, остальные данные сохраняются для агрегированной аналитики.

## Erasure flow
1. Администратор инициирует запрос — `privacy_erasure_queue` (идемпотентный upsert по `user_id`).
2. Порядок обработки: `events` → `user_alert_overrides` → `alerts_rules` → `alerts_events` → `user_subscriptions` → `portfolios` (каскадом `trades`, `positions`, `valuations_daily`) → анонимизация `bot_starts` → `users`.
3. Каждая операция фиксируется в `privacy_erasure_log` (`DELETE`/`ANONYMIZE`/`SKIP` + количество строк). Лог не содержит PII.
4. Финальный статус в очереди — `DONE`, `DRYRUN` или `ERROR` (с текстом ошибки без PII).
5. Повторные запуски идут без побочных эффектов (идемпотентность) и фиксируются как `SKIP` при отсутствии данных.

## Запросы субъектов данных (DSR)
- Запрос подтверждается администратором после внешней верификации личности.
- SLA выполнения удаления — **T+30 дней**.
- После обработки erasure администратор получает отчёт (API/CLI) и обновлённый статус в очереди.
- Очередь и журнал обеспечивают минимально достаточный аудит без хранения PII.
