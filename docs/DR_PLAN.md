# Disaster Recovery Plan (P31)

## Objectives / Цели
- **Recovery Point Objective (RPO)**: ≤ 24 hours — обеспечивается ночными бэкапами и еженедельной проверкой восстановления.
- **Recovery Time Objective (RTO)**: ≤ 1 час для среды staging — включает развертывание инфраструктуры и выполнение restore.sh.

## Backup Storage / Хранение бэкапов
- Автоматические nightly дампы через GitHub Actions (`db-backup.yml`). Артефакты сохраняются 7 дней.
- Ручные бэкапы для dev/test выполняются локально скриптом [`tools/db/backup.sh`](../tools/db/backup.sh) с хранением в каталоге `backups/` на рабочей станции.
- Все бэкапы подписаны `VERSION.txt` (версия приложения и дата генерации).

## Verification / Проверка бэкапов
- Еженедельный контрольный restore на staging-инфраструктуре.
- Ответственный SRE запускает [`tools/db/restore.sh`](../tools/db/restore.sh) на отдельном экземпляре БД.
- После восстановления выполняются sanity-check проверки (таблицы, Flyway, API, метрики).

## Restore Procedure / Пошаговое восстановление
1. **Коммуникация**: уведомить SRE/DevOps чат и владельцев продукта, зафиксировать инцидент в таск-трекере.
2. **Подготовка**: остановить приложение (deployment/cron/bot) для предотвращения записи в БД.
3. **Получение дампа**: скачать актуальный артефакт из GitHub Actions (`Releases → Artifacts`) или использовать локальный каталог `backups/YYYYMMDD_HHMMSS/`.
4. **Подключения**: экспортировать безопасные переменные (`APP_PROFILE`, `RESTORE_*` или `--target-url`) в окружение восстановительного хоста. Все креды берём из секретов CI/CD.
5. **Создание БД**: при необходимости создать пустую БД или очистить `public` (делает скрипт `restore.sh`).
6. **Восстановление**: выполнить `tools/db/restore.sh --dump <path>/db.dump --target-url postgres://...` с `I_UNDERSTAND=1`.
7. **Миграции**: `restore.sh` инициирует `./gradlew :storage:flywayInfo`; при необходимости запустить `:storage:flywayMigrate` вручную.
8. **Sanity-check**:
   - Проверить наличие таблиц `users`, `portfolios`, `trades`, `news_items`.
   - Запросить `/health` и `/metrics` сервиса; убедиться, что счётчики и лейблы корректны.
   - Выполнить smoke-тест API (план P05) и симулировать billing webhook (no-op).
9. **Возврат в строй**: включить приложение, наблюдать метрики и логи первые 30 минут.
10. **Отчётность**: задокументировать результат восстановления и обновить пост-мортем.

## Validation Checklist / Чек-лист валидации
- [ ] Таблицы присутствуют, количество строк соответствует ожиданиям (± допуск RPO).
- [ ] `/metrics` содержит актуальные счётчики (например, успехи ботов, latency-гистограммы).
- [ ] Smoke API тесты (P05) проходят без ошибок.
- [ ] Billing webhook симулируется без побочных эффектов.
- [ ] Flyway `info`/`migrate` выполняется без ошибок.

## Roles & Communication / Роли и коммуникации
- **Инициатор восстановления**: Senior SRE/DBA — принимает решение, запускает restore, валидирует данные.
- **Поддержка CI/CD**: Senior DevOps — контролирует GitHub Actions, артефакты, secrets.
- **Утверждение**: Engineering Manager / Product Owner — подтверждает окончание работ и релиз в прод.
- **Security**: следит за использованием секретов, отсутствием логирования чувствительных данных.
- **Каналы связи**: Slack `#incident-response`, телефонный мост, резервный email-список SRE.

## Security Considerations / Безопасность
- Секреты хранятся только в GitHub Secrets и переменных окружения; не записываются в логи и артефакты.
- Скрипты `backup.sh`/`restore.sh` прекращают работу при `APP_PROFILE=prod`.
- Ротация локальных бэкапов: хранить не более `N` каталогов (по умолчанию 7) и очищать устаревшие дампы.
- Артефакты GitHub Actions автоматически удаляются через 7 дней.
- Доступ к staging/restore окружению ограничен по SSH и аудитируется.
