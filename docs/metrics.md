# Метрики портфеля: P&L, IRR (XIRR), TWR

Документ описывает расчёты метрик портфеля и формат отчёта `/api/portfolio/{id}/report` при параметре `period`.

## Обозначения и знак потоков

* `CF(t)` — cashflow за период (в базовой валюте).
* `CF_cum(t)` — накопленный cashflow до даты/периода `t`.
* `V(t)` — valuation на конец даты/периода `t`.

Конвенция знаков для cashflow:

* `BUY` — отрицательный cashflow (вложение),
* `SELL` — положительный cashflow (изъятие),
* комиссии (`fee`) и налоги (`tax`) — отрицательные потоки.

Если в модели отсутствуют отдельные внешние движения денег, в отчёте используются именно trade cashflow (BUY/SELL/fee/tax).

## P&L

Формулы:

* `TotalPnL(t) = V(t) + CF_cum(t)`
* `DailyPnL(t) = TotalPnL(t) - TotalPnL(t-1)`

Таким образом комиссии и налоги учитываются в день факта, а ликвидированный портфель (V=0) остаётся корректно рассчитанным.

## IRR (XIRR)

Используется XIRR по датам (не фиксированный период):

```
NPV(r) = Σ CF_i / (1 + r) ^ yearFraction(date_i - date_0)
```

где `yearFraction = days / 365.0` (Actual/365).

В расчёт добавляется финальный cashflow: `+V(end)` в дату конца диапазона.

Статусы:

* `OK` — корень найден,
* `NO_ROOT` — нет смены знака (корня нет),
* `INVALID_INPUT` — недостаточно данных,
* `DIVERGED` — алгоритм не сошёлся.

## TWR

TWR считается по дневным точкам, внутри дня переоценки не учитываются.

* агрегация cashflow по датам: `CF_d`
* `V_d` — valuation на конец даты `d`

Для каждой даты `d` (кроме первой), если `V_prev > 0`:

```
r_d = (V_d + CF_d) / V_prev - 1
```

`CF_d` считается поступившим внутри дня и включённым в `V_d`, поэтому при отрицательных cashflow (BUY/fee/tax) в формуле используется `+ CF_d`.

Если `V_prev == 0`, день пропускается и цепочка начинается с первой даты, где `V_prev > 0`.

Статусы:

* `OK`,
* `INSUFFICIENT_DATA` (0/1 valuation point),
* `INVALID_INPUT` (NaN/Infinity).

## FX и флаг delayed

Источник FX — CBR XML_daily.

* `delayed=true`, если:
  * запрошенная дата не передана (`date_req` отсутствует), или
  * `effectiveDate` CBR не совпадает с запрошенной датой (например, выходной).

Если при расчёте отчёта хотя бы одна FX-конвертация была `delayed`, то в отчёте возвращается `delayed=true`.

## Периоды

* `daily` — календарный день.
* `weekly` — ISO-неделя, старт в понедельник.
* `monthly` — месяц `YearMonth`.

Для `weekly`/`monthly`:

* valuation берётся на конец периода,
* cashflow суммируется за период,
* поле `pnlDaily` отражает P&L за период.
* последний период считается "to-date": `periodEnd` равен последней дате valuation (as-of), чтобы не возвращать дату в будущем.

## Пример JSON

```json
{
  "portfolioId": "4f2a0b2c-8f6b-4a12-9b2d-5b7d2c9e2f10",
  "base": "RUB",
  "period": "daily",
  "delayed": false,
  "summary": {
    "totalPnL": "150.00000000",
    "irr": 0.1023,
    "irrStatus": "OK",
    "twr": 0.0987,
    "twrStatus": "OK"
  },
  "series": [
    {
      "date": "2024-03-01",
      "valuation": "1000.00000000",
      "cashflow": "-100.00000000",
      "pnlDaily": "900.00000000",
      "pnlTotal": "900.00000000"
    },
    {
      "date": "2024-03-02",
      "valuation": "1200.00000000",
      "cashflow": "0.00000000",
      "pnlDaily": "200.00000000",
      "pnlTotal": "1100.00000000"
    }
  ]
}
```

## Пример CSV

```
date,valuation,cashflow,pnlDaily,pnlTotal
2024-03-01,1000.00000000,-100.00000000,900.00000000,900.00000000
2024-03-02,1200.00000000,0.00000000,200.00000000,1100.00000000
```
