#!/usr/bin/env bash
set -euo pipefail

# 1) Block conflict markers
if git diff --cached --name-only \
 | xargs -I{} sh -c "grep -Hn -E '^(<<<<<<<|=======|>>>>>>>)' '{}' || true" \
 | grep -E '^(<<<<<<<|=======|>>>>>>>)' >/dev/null 2>&1; then
  echo "ERROR: merge conflict markers detected. Resolve before commit."
  exit 1
fi

# 2) Secrets scan (staged)
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks detect --staged --redact --config .gitleaks.toml --exit-code 1 --no-banner || {
    echo "ERROR: gitleaks found potential secrets in staged changes."; exit 1; }
else
  if command -v docker >/dev/null 2>&1; then
    docker run --rm -v "$PWD":/repo -w /repo gitleaks/gitleaks:latest \
      detect --staged --redact --config /repo/.gitleaks.toml --exit-code 1 --no-banner || {
      echo "ERROR: gitleaks (docker) found potential secrets."; exit 1; }
  else
    echo "WARN: gitleaks not found; skipping secrets scan."
  fi
fi

# 3) Fast lint, if gradlew present
if [ -x "./gradlew" ]; then
  ./gradlew -q ktlintCheck detekt || {
    echo "ERROR: ktlint/detekt violations. Run: ./gradlew ktlintFormat"; exit 1; }
fi

exit 0
