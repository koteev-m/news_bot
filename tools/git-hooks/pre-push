#!/usr/bin/env bash
set -euo pipefail

red()    { printf '\033[31m%s\033[0m\n' "$*"; }
green()  { printf '\033[32m%s\033[0m\n' "$*"; }
yellow() { printf '\033[33m%s\033[0m\n' "$*"; }

repo_root=$(git rev-parse --show-toplevel)
cd "$repo_root"

if git grep -nE '^(<<<<<<<|=======|>>>>>>>)' -- . >/dev/null 2>&1; then
  red "[FAIL] merge-conflict markers detected; resolve conflicts before pushing"
  exit 1
fi

run_all="$repo_root/tools/audit/run_all.sh"
if [[ ! -x "$run_all" ]]; then
  yellow "[WARN] tools/audit/run_all.sh missing; reinstall hooks with ./gradlew installGitHooks"
  exit 0
fi

yellow "[INFO] Running pre-push audit (skip build)"
if ! "$run_all" --skip-build; then
  status=$?
  red "[FAIL] pre-push checks failed"
  yellow "[INFO] To reproduce: bash tools/audit/run_all.sh --skip-build"
  exit "$status"
fi

green "[OK] pre-push checks passed"
exit 0
