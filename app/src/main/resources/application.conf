telegram {
  botToken = ${?TELEGRAM_BOT_TOKEN}
  botUsername = ${?TELEGRAM_BOT_USERNAME}
  botId = ${?TELEGRAM_BOT_ID}
  webhookSecret = ${?TELEGRAM_WEBHOOK_SECRET}
  channelId = -1002217246986
  channelUsername = "crypto_is_mine"
  channelTitle = "Цифровая Экономика"
  adminUserId = 7446417641
}

webhook {
  queue {
    capacity = 1000          # max in-queue items
    workers  = 4             # parallel consumers
    overflow = "drop_oldest" # drop_oldest | drop_latest
  }
}

performance {
  workerThreads = 8

  db {
    poolMax = 10
    poolMinIdle = 2
  }

  httpClient {
    maxConnectionsPerRoute = 100
    keepAliveSeconds = 30
  }

  cacheTtlMs {
    moex      = 15000
    coingecko = 15000
    cbr       = 60000
  }
}

db {
  jdbcUrl = ${?DATABASE_URL}
  username = ${?DATABASE_USER}
  password = ${?DATABASE_PASS}
  maximumPoolSize = 10
  minimumIdle = 2
  driver = "org.postgresql.Driver"
  schema = "public"
}

integrations {
  appName = "newsbot/0.1.0"
  appName = ${?INTEGRATIONS_APP_NAME}
  userAgent = "newsbot-integrations/1.0"
  userAgent = ${?INTEGRATIONS_USER_AGENT}

  http {
    timeoutMs {
      connect = 2000
      socket  = 3000
      request = 4000
    }
    retry {
      maxAttempts = 3
      baseBackoffMs = 300
      jitterMs      = 200
      respectRetryAfter = true
      retryOn = [429, 500, 502, 503, 504]
    }
    circuitBreaker {
      failuresThreshold = 5        # сколько ошибок в окне переводит CB в OPEN
      windowSeconds     = 60       # окно ошибок
      openSeconds       = 30       # пауза в OPEN
      halfOpenMaxCalls  = 2        # пробные вызовы
    }
  }

  moex {
    baseUrl = "https://iss.moex.com"
    baseUrl = ${?MOEX_BASE_URL}
  }

  coingecko {
    baseUrl = "https://api.coingecko.com"
    baseUrl = ${?COINGECKO_BASE_URL}
  }

  cbr {
    baseUrl = "https://www.cbr.ru"
    baseUrl = ${?CBR_BASE_URL}
  }
}

pricing {
  preferClosePrice = true
  preferClosePrice = ${?PRICING_PREFER_CLOSE_PRICE}
  fallbackToLast = true
  fallbackToLast = ${?PRICING_FALLBACK_TO_LAST}
}

portfolio {
  defaultValuationMethod = "AVERAGE"
  defaultValuationMethod = ${?PORTFOLIO_DEFAULT_VALUATION_METHOD}
  autoCreateInstruments = true
  autoCreateInstruments = ${?PORTFOLIO_AUTO_CREATE_INSTRUMENTS}
}

import {
  byUrlEnabled = false
  byUrlRateLimit {
    capacity = 3
    refillPerMinute = 3
  }
}

billing {
  # Дней к продлению подписки при успешном платеже
  defaultDurationDays = 30
  defaultDurationDays = ${?BILLING_DEFAULT_DURATION_DAYS}
}

security {
  jwtSecretPrimary   = "test_secret_change_me"
  jwtSecretPrimary   = ${?JWT_SECRET_PRIMARY}
  jwtSecretSecondary = ${?JWT_SECRET_SECONDARY}
  issuer   = "newsbot"
  audience = "newsbot-clients"
  realm    = "newsbot-api"
  accessTtlMinutes = 60
  webappTtlMinutes = 15
  rateLimit {
    capacity = 60
    refillPerMinute = 60
    burst = 20
  }
}

upload {
  csvMaxBytes = 1048576
  allowedCsvContentTypes = ["text/csv","application/octet-stream","application/vnd.ms-excel"]
}

alerts {
  quiet {
    start = "23:00"
    end   = "07:00"
  }
  budget {
    maxPushesPerDay = 6
  }
  hysteresis {
    enterPct = 2.0
    exitPct  = 1.5
  }
  cooldownMinutes = 60
  dynamic {
    enabled = false
    min = 0.7
    max = 1.3
  }
  matrix {
    portfolioDayPct   = 2.0
    portfolioDrawdown = 5.0
    perClass = {
      MOEX_BLUE     = { pctFast = 2.0, pctDay = 4.0, volMultFast = 1.8 }
      MOEX_SECOND   = { pctFast = 3.0, pctDay = 6.0, volMultFast = 2.2 }
      OFZ           = { pctFast = 0.3, pctDay = 0.6 }
      INDEX         = { pctFast = 0.7, pctDay = 1.5 }
      FX            = { pctFast = 1.0, pctDay = 2.0 }
      CRYPTO_MAJOR  = { pctFast = 2.0, pctDay = 4.0, volMultFast = 2.0 }
      CRYPTO_MID    = { pctFast = 4.0, pctDay = 8.0, volMultFast = 2.5 }
      STABLECOIN    = { pctFast = 0.5, pctDay = 0.8 }
    }
  }
}

admin {
  adminUserIds = [ 7446417641 ]
}

privacy {
  retention {
    analyticsDays = 90   # events.*
    alertsDays    = 30   # alerts_events.*
    botStartsDays = 30   # anonymize user_id in bot_starts
  }
  erasure {
    enabled   = true
    dryRun    = false       # if true, count-only
    batchSize = 5000       # per-table batch
  }
}

features {
  importByUrl  = false
  webhookQueue = true
  newsPublish  = true
  alertsEngine = true
  billingStars = true
  miniApp      = true
}
